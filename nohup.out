🔑 Inicializando servidor de WhatsApp con las siguientes credenciales:
📱 GUPSHUP_NUMBER: 15557033313
🔑 GUPSHUP_API_KEY: sk_58a31...a6e6b
👤 GUPSHUP_USERID: crxty1qf...
🔗 SUPABASE_URL: https://wscijkxwevgxbgwhbqtm.supabase.co
🖥️ CONTROL_PANEL_URL: http://localhost:3010/api/register-bot-response
📢 GLOBAL-PATCH: Verificando variables al inicio:
- CONTROL_PANEL_URL: http://localhost:3010/api/register-bot-response
- NODE_ENV: development
- RENDER: no definido
✅ Usando SUPABASE_URL desde variable de entorno
✅ Usando BUSINESS_ID desde variable de entorno
✅ node-fetch cargado exitosamente
🔄 Inicializando cliente Supabase...
✅ Cliente Supabase inicializado correctamente
🔍 FIX-REAL-BOT: Estado de URL antes de procesar:
- CONTROL_PANEL_URL: http://localhost:3010/api/register-bot-response
- NODE_ENV: development
- RENDER: no definido
🔍 FIX-REAL-BOT: Usando selección de URL para entorno de desarrollo
🌐 Ambiente de DESARROLLO detectado - Intentando URL local
🔍 Verificando disponibilidad de servidor local en desarrollo: disponible
⚠️ Detectada URL con ruta incluida. Corrigiendo para usar solo el dominio base...
⚠️ URL original: http://localhost:3010/api/register-bot-response
✅ URL corregida a dominio base: http://localhost:3010
✅ URL base guardada en variable de entorno
🌐 Ambiente de DESARROLLO detectado - Intentando URL local
🔍 Verificando disponibilidad de servidor local en desarrollo: disponible
🔧 APLICANDO PARCHE PARA CORREGIR URLs DEL BOT WHATSAPP
CONTROL_PANEL_URL actual: http://localhost:3010
Ambiente: Desarrollo
URL que se usará: http://localhost:3010
📡 VERIFICACIÓN DE ACCESO A SUPABASE
🔍 Intentando acceder a Supabase (https://wscijkxwevgxbgwhbqtm.supabase.co) con Axios...
📌 GLOBAL-PATCH: URL final: http://localhost:3010
🔧 PARCHE GLOBAL APLICADO
✅ Función global.registerBotResponse definida
ℹ️ Guardando mensajes en Supabase: https://wscijkxwevgxbgwhbqtm.supabase.co
🔧 APLICANDO PARCHE PARA CORREGIR URLs DEL BOT WHATSAPP
Ambiente: Desarrollo
Render detectado: NO
CONTROL_PANEL_URL actual: http://localhost:3010
URL final que se usará: http://localhost:3010/register-bot-response
✅ Parche aplicado correctamente
📝 De ahora en adelante, las URLs duplicadas serán corregidas automáticamente
🌐 En ambiente de producción, se usará: URL de desarrollo
🔍 También puedes usar la función global registerBotResponse() para enviar mensajes
🔑 API Keys cargadas:
OPENAI_API_KEY: ✅ OK
GUPSHUP_API_KEY: ✅ OK
GUPSHUP_NUMBER: ✅ OK
GUPSHUP_USERID: ✅ OK
CONTROL_PANEL_URL: http://localhost:3010/register-bot-response
🔑 DEBUG - Variables de entorno para Supabase:
- SUPABASE_URL: https://wscijkxwevgxbgwhbqtm.supabase.co
- SUPABASE_ANON_KEY: eyJhbGciOi...
- SUPABASE_KEY: no definido
- NEXT_PUBLIC_SUPABASE_ANON_KEY: no definido
✅ Credenciales de Supabase encontradas correctamente
🔑 Usando clave de Supabase (primeros 10 caracteres): eyJhbGciOi...
🚀 Servidor iniciado en puerto 3090
🤖 Bot conectado al panel: http://localhost:3010/register-bot-response
🔍 Verificando credenciales de integración...
✅ Credenciales de GupShup presentes:
  - API Key: sk_58a31...
  - Número de origen: 15557033313
  - User ID: crxty1qf...
✅ Clave API de OpenAI configurada: sk-svcac...
🔄 Inicializando mapeos y estados...
🔄 Actualizando mapeos de conversaciones y números...
✅ SUPABASE ACCESIBLE VIA AXIOS: 200
✅ CONTENIDO DE RESPUESTA: [{"id":"9471be7e-1cd5-4b96-abaa-58749f1a5d3e","user_id":"4a42aa05-2ffd-418b-aa52-29e7c571eee8","busi...
🔍 Intentando acceder a Supabase (https://wscijkxwevgxbgwhbqtm.supabase.co) con Fetch nativo...
🔍 Encontradas 22 conversaciones para mapeo
✅ Mapeos actualizados: 16 números mapeados
🔄 Cargando estados de bot activo...
✅ SUPABASE ACCESIBLE VIA FETCH NATIVO: 200
✅ CONTENIDO DE RESPUESTA: [{"id":"9471be7e-1cd5-4b96-abaa-58749f1a5d3e","user_id":"4a42aa05-2ffd-418b-aa52-29e7c571eee8","busi...
🔍 Intentando acceder a Supabase (https://wscijkxwevgxbgwhbqtm.supabase.co) con node-fetch...
ℹ️ Bot para 4a42aa05-2ffd-418b-aa52-29e7c571eee8: ACTIVO
ℹ️ Bot para 5491123456789: ACTIVO
ℹ️ Bot para +12223334444: ACTIVO
ℹ️ Bot para +19876543210: ACTIVO
ℹ️ Bot para +5493513123456: ACTIVO
ℹ️ Bot para 522221192568: ACTIVO
ℹ️ Bot para test: ACTIVO
ℹ️ Bot para +15557033313: ACTIVO
ℹ️ Bot para 5212221192568: ACTIVO
ℹ️ Bot para ARCHIVED_92568: ACTIVO
ℹ️ Bot para ARCHIVED_92568: ACTIVO
ℹ️ Bot para ARCHIVED_92568: ACTIVO
ℹ️ Bot para ARCHIVED_92568: ACTIVO
ℹ️ Bot para ARCHIVED_92568: ACTIVO
ℹ️ Bot para ARCHIVED_92568: ACTIVO
ℹ️ Bot para ARCHIVED_92568: ACTIVO
ℹ️ Bot para 5212221192568_TEST_2: ACTIVO
ℹ️ Bot para +11234567890: INACTIVO
ℹ️ Bot para 5219876543210: ACTIVO
ℹ️ Bot para 5219999888777: ACTIVO
ℹ️ Bot para +5213341495625: ACTIVO
ℹ️ Bot para 5212213647963: INACTIVO
✅ Estados de bot cargados para 16 conversaciones
✅ SUPABASE ACCESIBLE VIA NODE-FETCH: 200
✅ CONTENIDO DE RESPUESTA: [{"id":"9471be7e-1cd5-4b96-abaa-58749f1a5d3e","user_id":"4a42aa05-2ffd-418b-aa52-29e7c571eee8","busi...
📡 FIN DE VERIFICACIÓN DE ACCESO A SUPABASE
🔄 POST /api/send-manual-message - Origin: Unknown
📥 POST /api/send-manual-message
📝 Recibida solicitud para enviar mensaje manual: {"phoneNumber":"5212221192568","message":"Gracias por agendar tu cita con nosotros. Te esperamos mañana en la hora acordada. Visita Calendly para más detalles.","forceManual":true}
💬 Detectada solicitud de mensaje de texto: "Gracias por agendar tu cita con nosotros. Te esper..."
🔑 Credenciales a usar:
   API_KEY: sk_58...a6e6b
   USERID: crxty1qflktvwvm7sodtrfe9dpvoowm1
   NUMERO: 15557033313
🔗 URL del endpoint: https://api.gupshup.io/wa/api/v1/msg
📝 Contenido del mensaje: {"type":"text","text":"Gracias por agendar tu cita con nosotros. Te esperamos mañana en la hora acordada. Visita Calendly para más detalles."}
📤 FormData preparado: channel=whatsapp&source=15557033313&destination=5212221192568&message=%7B%22type%22%3A%22text%22%2C%22text%22%3A%22Gracias+por+agendar+tu+cita+con+nosotros.+Te+esperamos+ma%C3%B1ana+en+la+hora+acordada.+Visita+Calendly+para+m%C3%A1s+detalles.%22%7D&src.name=SeatManager
🌐 Enviando solicitud HTTP POST a GupShup...
✅ Respuesta recibida de GupShup: 202
📄 Datos de respuesta: {
  status: 'submitted',
  messageId: 'a9bf4a3b-fb26-430d-9d6f-d814956f455d'
}
🔔 ANALIZANDO MENSAJE PARA DETECTAR FRASES DE NOTIFICACIÓN:
🔔 Mensaje a analizar: "Gracias por agendar tu cita con nosotros. Te esperamos mañana en la hora acordada. Visita Calendly para más detalles."
🔔 Frases que activan notificaciones:
   1. "he registrado tu solicitud para hablar con un asesor"
   2. "un representante se pondrá en contacto contigo"
   3. "tu cita ha sido agendada para"
   4. "hemos registrado tu cita para el día"
   5. "cita confirmada para el"
   6. "cita para"
   7. "calendly"
   8. "agendar cita"
   9. "link donde podrás registrarla"
   10. "te llamaremos pronto al número"
   11. "hemos registrado tu solicitud de llamada"
   12. "recibirás una llamada en"
   13. "daremos seguimiento a tu caso"
   14. "caso registrado con el folio"
   - Frase "he registrado tu solicitud para hablar con un asesor": ❌ No encontrada
   - Frase "un representante se pondrá en contacto contigo": ❌ No encontrada
   - Frase "tu cita ha sido agendada para": ❌ No encontrada
   - Frase "hemos registrado tu cita para el día": ❌ No encontrada
   - Frase "cita confirmada para el": ❌ No encontrada
   - Frase "cita para": ❌ No encontrada
   - Frase "calendly": ✅ ENCONTRADA
🔔 DETECTADA FRASE QUE REQUIERE NOTIFICACIÓN en mensaje enviado a 5212221192568
🔍 Buscando conversación para número: 5212221192568
📧 Conversación encontrada: 4a42aa05-2ffd-418b-aa52-29e7c571eee8
📧 Iniciando envío de notificación para conversación 4a42aa05-2ffd-418b-aa52-29e7c571eee8
📧 INICIANDO PROCESO DE NOTIFICACIÓN para conversación: 4a42aa05-2ffd-418b-aa52-29e7c571eee8
📧 Mensaje del bot que activó la notificación: "Gracias por agendar tu cita con nosotros. Te esperamos mañana en la hora acordada. Visita Calendly para más detalles."
📧 Número de teléfono del cliente: 5212221192568
🔍 Buscando perfil para el negocio ID: 2d385aa5-40e0-4ec9-9360-19281bc605e4
✅ Se encontraron 1 perfiles en total
⚠️ No se encontró perfil exacto para 2d385aa5-40e0-4ec9-9360-19281bc605e4, buscando alternativa...
ℹ️ Usando email del primer perfil disponible: hernan.baigts@gmail.com
📧 Información del negocio obtenida: ID=2d385aa5-40e0-4ec9-9360-19281bc605e4, Nombre=Hernán Tenorio
📧 Email del negocio: hernan.baigts@gmail.com
📧 Información del cliente obtenida: Cliente
📧 Historial de conversación obtenido: 10 mensajes
📧 Tipo de notificación determinado: cita, Asunto: 📅 Nueva Cita Agendada
📧 Datos extraídos para cita: Fecha=No detectada, Hora=No detectada
📧 Email de destino final: hernan.baigts@gmail.com
📧 Agregando BCC: copia@brexor.com
📧 Preparando para enviar correo a: hernan.baigts@gmail.com
📧 Remitente: bexorai@gmail.com
✅ Correo de notificación enviado a hernan.baigts@gmail.com: <42fbaaeb-61a5-95a5-bc11-650b7f81267f@gmail.com>
✅ Notificación registrada en la base de datos
✅ Mensaje de texto enviado exitosamente a 5212221192568
