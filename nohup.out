ğŸ”‘ Inicializando servidor de WhatsApp con las siguientes credenciales:
ğŸ“± GUPSHUP_NUMBER: 15557033313
ğŸ”‘ GUPSHUP_API_KEY: sk_58a31...a6e6b
ğŸ‘¤ GUPSHUP_USERID: crxty1qf...
ğŸ”— SUPABASE_URL: https://wscijkxwevgxbgwhbqtm.supabase.co
ğŸ–¥ï¸ CONTROL_PANEL_URL: http://localhost:3010/api/register-bot-response
ğŸ“¢ GLOBAL-PATCH: Verificando variables al inicio:
- CONTROL_PANEL_URL: http://localhost:3010/api/register-bot-response
- NODE_ENV: development
- RENDER: no definido
âœ… Usando SUPABASE_URL desde variable de entorno
âœ… Usando BUSINESS_ID desde variable de entorno
âœ… node-fetch cargado exitosamente
ğŸ”„ Inicializando cliente Supabase...
âœ… Cliente Supabase inicializado correctamente
ğŸ” FIX-REAL-BOT: Estado de URL antes de procesar:
- CONTROL_PANEL_URL: http://localhost:3010/api/register-bot-response
- NODE_ENV: development
- RENDER: no definido
ğŸ” FIX-REAL-BOT: Usando selecciÃ³n de URL para entorno de desarrollo
ğŸŒ Ambiente de DESARROLLO detectado - Intentando URL local
ğŸ” Verificando disponibilidad de servidor local en desarrollo: disponible
âš ï¸ Detectada URL con ruta incluida. Corrigiendo para usar solo el dominio base...
âš ï¸ URL original: http://localhost:3010/api/register-bot-response
âœ… URL corregida a dominio base: http://localhost:3010
âœ… URL base guardada en variable de entorno
ğŸŒ Ambiente de DESARROLLO detectado - Intentando URL local
ğŸ” Verificando disponibilidad de servidor local en desarrollo: disponible
ğŸ”§ APLICANDO PARCHE PARA CORREGIR URLs DEL BOT WHATSAPP
CONTROL_PANEL_URL actual: http://localhost:3010
Ambiente: Desarrollo
URL que se usarÃ¡: http://localhost:3010
ğŸ“¡ VERIFICACIÃ“N DE ACCESO A SUPABASE
ğŸ” Intentando acceder a Supabase (https://wscijkxwevgxbgwhbqtm.supabase.co) con Axios...
ğŸ“Œ GLOBAL-PATCH: URL final: http://localhost:3010
ğŸ”§ PARCHE GLOBAL APLICADO
âœ… FunciÃ³n global.registerBotResponse definida
â„¹ï¸ Guardando mensajes en Supabase: https://wscijkxwevgxbgwhbqtm.supabase.co
ğŸ”§ APLICANDO PARCHE PARA CORREGIR URLs DEL BOT WHATSAPP
Ambiente: Desarrollo
Render detectado: NO
CONTROL_PANEL_URL actual: http://localhost:3010
URL final que se usarÃ¡: http://localhost:3010/register-bot-response
âœ… Parche aplicado correctamente
ğŸ“ De ahora en adelante, las URLs duplicadas serÃ¡n corregidas automÃ¡ticamente
ğŸŒ En ambiente de producciÃ³n, se usarÃ¡: URL de desarrollo
ğŸ” TambiÃ©n puedes usar la funciÃ³n global registerBotResponse() para enviar mensajes
ğŸ”‘ API Keys cargadas:
OPENAI_API_KEY: âœ… OK
GUPSHUP_API_KEY: âœ… OK
GUPSHUP_NUMBER: âœ… OK
GUPSHUP_USERID: âœ… OK
CONTROL_PANEL_URL: http://localhost:3010/register-bot-response
ğŸ”‘ DEBUG - Variables de entorno para Supabase:
- SUPABASE_URL: https://wscijkxwevgxbgwhbqtm.supabase.co
- SUPABASE_ANON_KEY: eyJhbGciOi...
- SUPABASE_KEY: no definido
- NEXT_PUBLIC_SUPABASE_ANON_KEY: no definido
âœ… Credenciales de Supabase encontradas correctamente
ğŸ”‘ Usando clave de Supabase (primeros 10 caracteres): eyJhbGciOi...
ğŸš€ Servidor iniciado en puerto 3090
ğŸ¤– Bot conectado al panel: http://localhost:3010/register-bot-response
ğŸ” Verificando credenciales de integraciÃ³n...
âœ… Credenciales de GupShup presentes:
  - API Key: sk_58a31...
  - NÃºmero de origen: 15557033313
  - User ID: crxty1qf...
âœ… Clave API de OpenAI configurada: sk-svcac...
ğŸ”„ Inicializando mapeos y estados...
ğŸ”„ Actualizando mapeos de conversaciones y nÃºmeros...
âœ… SUPABASE ACCESIBLE VIA AXIOS: 200
âœ… CONTENIDO DE RESPUESTA: [{"id":"9471be7e-1cd5-4b96-abaa-58749f1a5d3e","user_id":"4a42aa05-2ffd-418b-aa52-29e7c571eee8","busi...
ğŸ” Intentando acceder a Supabase (https://wscijkxwevgxbgwhbqtm.supabase.co) con Fetch nativo...
ğŸ” Encontradas 22 conversaciones para mapeo
âœ… Mapeos actualizados: 16 nÃºmeros mapeados
ğŸ”„ Cargando estados de bot activo...
âœ… SUPABASE ACCESIBLE VIA FETCH NATIVO: 200
âœ… CONTENIDO DE RESPUESTA: [{"id":"9471be7e-1cd5-4b96-abaa-58749f1a5d3e","user_id":"4a42aa05-2ffd-418b-aa52-29e7c571eee8","busi...
ğŸ” Intentando acceder a Supabase (https://wscijkxwevgxbgwhbqtm.supabase.co) con node-fetch...
â„¹ï¸ Bot para 4a42aa05-2ffd-418b-aa52-29e7c571eee8: ACTIVO
â„¹ï¸ Bot para 5491123456789: ACTIVO
â„¹ï¸ Bot para +12223334444: ACTIVO
â„¹ï¸ Bot para +19876543210: ACTIVO
â„¹ï¸ Bot para +5493513123456: ACTIVO
â„¹ï¸ Bot para 522221192568: ACTIVO
â„¹ï¸ Bot para test: ACTIVO
â„¹ï¸ Bot para +15557033313: ACTIVO
â„¹ï¸ Bot para 5212221192568: ACTIVO
â„¹ï¸ Bot para ARCHIVED_92568: ACTIVO
â„¹ï¸ Bot para ARCHIVED_92568: ACTIVO
â„¹ï¸ Bot para ARCHIVED_92568: ACTIVO
â„¹ï¸ Bot para ARCHIVED_92568: ACTIVO
â„¹ï¸ Bot para ARCHIVED_92568: ACTIVO
â„¹ï¸ Bot para ARCHIVED_92568: ACTIVO
â„¹ï¸ Bot para ARCHIVED_92568: ACTIVO
â„¹ï¸ Bot para 5212221192568_TEST_2: ACTIVO
â„¹ï¸ Bot para +11234567890: INACTIVO
â„¹ï¸ Bot para 5219876543210: ACTIVO
â„¹ï¸ Bot para 5219999888777: ACTIVO
â„¹ï¸ Bot para +5213341495625: ACTIVO
â„¹ï¸ Bot para 5212213647963: INACTIVO
âœ… Estados de bot cargados para 16 conversaciones
âœ… SUPABASE ACCESIBLE VIA NODE-FETCH: 200
âœ… CONTENIDO DE RESPUESTA: [{"id":"9471be7e-1cd5-4b96-abaa-58749f1a5d3e","user_id":"4a42aa05-2ffd-418b-aa52-29e7c571eee8","busi...
ğŸ“¡ FIN DE VERIFICACIÃ“N DE ACCESO A SUPABASE
ğŸ”„ POST /api/send-manual-message - Origin: Unknown
ğŸ“¥ POST /api/send-manual-message
ğŸ“ Recibida solicitud para enviar mensaje manual: {"phoneNumber":"5212221192568","message":"Gracias por agendar tu cita con nosotros. Te esperamos maÃ±ana en la hora acordada. Visita Calendly para mÃ¡s detalles.","forceManual":true}
ğŸ’¬ Detectada solicitud de mensaje de texto: "Gracias por agendar tu cita con nosotros. Te esper..."
ğŸ”‘ Credenciales a usar:
   API_KEY: sk_58...a6e6b
   USERID: crxty1qflktvwvm7sodtrfe9dpvoowm1
   NUMERO: 15557033313
ğŸ”— URL del endpoint: https://api.gupshup.io/wa/api/v1/msg
ğŸ“ Contenido del mensaje: {"type":"text","text":"Gracias por agendar tu cita con nosotros. Te esperamos maÃ±ana en la hora acordada. Visita Calendly para mÃ¡s detalles."}
ğŸ“¤ FormData preparado: channel=whatsapp&source=15557033313&destination=5212221192568&message=%7B%22type%22%3A%22text%22%2C%22text%22%3A%22Gracias+por+agendar+tu+cita+con+nosotros.+Te+esperamos+ma%C3%B1ana+en+la+hora+acordada.+Visita+Calendly+para+m%C3%A1s+detalles.%22%7D&src.name=SeatManager
ğŸŒ Enviando solicitud HTTP POST a GupShup...
âœ… Respuesta recibida de GupShup: 202
ğŸ“„ Datos de respuesta: {
  status: 'submitted',
  messageId: 'a9bf4a3b-fb26-430d-9d6f-d814956f455d'
}
ğŸ”” ANALIZANDO MENSAJE PARA DETECTAR FRASES DE NOTIFICACIÃ“N:
ğŸ”” Mensaje a analizar: "Gracias por agendar tu cita con nosotros. Te esperamos maÃ±ana en la hora acordada. Visita Calendly para mÃ¡s detalles."
ğŸ”” Frases que activan notificaciones:
   1. "he registrado tu solicitud para hablar con un asesor"
   2. "un representante se pondrÃ¡ en contacto contigo"
   3. "tu cita ha sido agendada para"
   4. "hemos registrado tu cita para el dÃ­a"
   5. "cita confirmada para el"
   6. "cita para"
   7. "calendly"
   8. "agendar cita"
   9. "link donde podrÃ¡s registrarla"
   10. "te llamaremos pronto al nÃºmero"
   11. "hemos registrado tu solicitud de llamada"
   12. "recibirÃ¡s una llamada en"
   13. "daremos seguimiento a tu caso"
   14. "caso registrado con el folio"
   - Frase "he registrado tu solicitud para hablar con un asesor": âŒ No encontrada
   - Frase "un representante se pondrÃ¡ en contacto contigo": âŒ No encontrada
   - Frase "tu cita ha sido agendada para": âŒ No encontrada
   - Frase "hemos registrado tu cita para el dÃ­a": âŒ No encontrada
   - Frase "cita confirmada para el": âŒ No encontrada
   - Frase "cita para": âŒ No encontrada
   - Frase "calendly": âœ… ENCONTRADA
ğŸ”” DETECTADA FRASE QUE REQUIERE NOTIFICACIÃ“N en mensaje enviado a 5212221192568
ğŸ” Buscando conversaciÃ³n para nÃºmero: 5212221192568
ğŸ“§ ConversaciÃ³n encontrada: 4a42aa05-2ffd-418b-aa52-29e7c571eee8
ğŸ“§ Iniciando envÃ­o de notificaciÃ³n para conversaciÃ³n 4a42aa05-2ffd-418b-aa52-29e7c571eee8
ğŸ“§ INICIANDO PROCESO DE NOTIFICACIÃ“N para conversaciÃ³n: 4a42aa05-2ffd-418b-aa52-29e7c571eee8
ğŸ“§ Mensaje del bot que activÃ³ la notificaciÃ³n: "Gracias por agendar tu cita con nosotros. Te esperamos maÃ±ana en la hora acordada. Visita Calendly para mÃ¡s detalles."
ğŸ“§ NÃºmero de telÃ©fono del cliente: 5212221192568
ğŸ” Buscando perfil para el negocio ID: 2d385aa5-40e0-4ec9-9360-19281bc605e4
âœ… Se encontraron 1 perfiles en total
âš ï¸ No se encontrÃ³ perfil exacto para 2d385aa5-40e0-4ec9-9360-19281bc605e4, buscando alternativa...
â„¹ï¸ Usando email del primer perfil disponible: hernan.baigts@gmail.com
ğŸ“§ InformaciÃ³n del negocio obtenida: ID=2d385aa5-40e0-4ec9-9360-19281bc605e4, Nombre=HernÃ¡n Tenorio
ğŸ“§ Email del negocio: hernan.baigts@gmail.com
ğŸ“§ InformaciÃ³n del cliente obtenida: Cliente
ğŸ“§ Historial de conversaciÃ³n obtenido: 10 mensajes
ğŸ“§ Tipo de notificaciÃ³n determinado: cita, Asunto: ğŸ“… Nueva Cita Agendada
ğŸ“§ Datos extraÃ­dos para cita: Fecha=No detectada, Hora=No detectada
ğŸ“§ Email de destino final: hernan.baigts@gmail.com
ğŸ“§ Agregando BCC: copia@brexor.com
ğŸ“§ Preparando para enviar correo a: hernan.baigts@gmail.com
ğŸ“§ Remitente: bexorai@gmail.com
âœ… Correo de notificaciÃ³n enviado a hernan.baigts@gmail.com: <42fbaaeb-61a5-95a5-bc11-650b7f81267f@gmail.com>
âœ… NotificaciÃ³n registrada en la base de datos
âœ… Mensaje de texto enviado exitosamente a 5212221192568
